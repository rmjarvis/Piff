
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <title>piff.psf &#8212; Piff 0.4 documentation</title>
    <link rel="stylesheet" href="../../_static/classic.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    
    <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
    <script src="../../_static/jquery.js"></script>
    <script src="../../_static/underscore.js"></script>
    <script src="../../_static/doctools.js"></script>
    <script src="../../_static/language_data.js"></script>
    <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
  </head><body>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             accesskey="I">index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Piff 0.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" accesskey="U">Module code</a> &#187;</li> 
      </ul>
    </div>  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          <div class="body" role="main">
            
  <h1>Source code for piff.psf</h1><div class="highlight"><pre>
<span></span><span class="c1"># Copyright (c) 2016 by Mike Jarvis and the other collaborators on GitHub at</span>
<span class="c1"># https://github.com/rmjarvis/Piff  All rights reserved.</span>
<span class="c1">#</span>
<span class="c1"># Piff is free software: Redistribution and use in source and binary forms</span>
<span class="c1"># with or without modification, are permitted provided that the following</span>
<span class="c1"># conditions are met:</span>
<span class="c1">#</span>
<span class="c1"># 1. Redistributions of source code must retain the above copyright notice, this</span>
<span class="c1">#    list of conditions and the disclaimer given in the accompanying LICENSE</span>
<span class="c1">#    file.</span>
<span class="c1"># 2. Redistributions in binary form must reproduce the above copyright notice,</span>
<span class="c1">#    this list of conditions and the disclaimer given in the documentation</span>
<span class="c1">#    and/or other materials provided with the distribution.</span>

<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">.. module:: psf</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="kn">from</span> <span class="nn">__future__</span> <span class="kn">import</span> <span class="n">print_function</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">fitsio</span>
<span class="kn">import</span> <span class="nn">galsim</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="kn">from</span> <span class="nn">.star</span> <span class="kn">import</span> <span class="n">Star</span><span class="p">,</span> <span class="n">StarData</span>
<span class="kn">from</span> <span class="nn">.util</span> <span class="kn">import</span> <span class="n">write_kwargs</span><span class="p">,</span> <span class="n">read_kwargs</span>

<div class="viewcode-block" id="PSF"><a class="viewcode-back" href="../../psf.html#piff.PSF">[docs]</a><span class="k">class</span> <span class="nc">PSF</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The base class for describing a PSF model across a field of view.</span>

<span class="sd">    The usual way to create a PSF is through one of the two factory functions::</span>

<span class="sd">        &gt;&gt;&gt; psf = piff.PSF.process(config, logger)</span>
<span class="sd">        &gt;&gt;&gt; psf = piff.PSF.read(file_name, logger)</span>

<span class="sd">    The first is used to build a PSF model from the data according to a config dict.</span>
<span class="sd">    The second is used to read in a PSF model from disk.</span>
<span class="sd">    &quot;&quot;&quot;</span>
<div class="viewcode-block" id="PSF.process"><a class="viewcode-back" href="../../psf.html#piff.PSF.process">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">process</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_psf</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Process the config dict and return a PSF instance.</span>

<span class="sd">        As the PSF class is an abstract base class, the returned type will in fact be some</span>
<span class="sd">        subclass of PSF according to the contents of the config dict.</span>

<span class="sd">        The provided config dict is typically the &#39;psf&#39; field in the base config dict in</span>
<span class="sd">        a YAML file, although for compound PSF types, it may be the field for just one of</span>
<span class="sd">        several components.</span>

<span class="sd">        This function merely creates a &quot;blank&quot; PSF object.  It does not actually do any</span>
<span class="sd">        part of the solution yet.  Typically this will be followed by fit:</span>

<span class="sd">            &gt;&gt;&gt; psf = piff.PSF.process(config[&#39;psf&#39;])</span>
<span class="sd">            &gt;&gt;&gt; stars, wcs, pointing = piff.Input.process(config[&#39;input&#39;])</span>
<span class="sd">            &gt;&gt;&gt; psf.fit(stars, wcs, pointing)</span>

<span class="sd">        at which point, the ``psf`` instance would have a solution to the PSF model.</span>

<span class="sd">        :param config_psf:  A dict specifying what type of PSF to build along with the</span>
<span class="sd">                            appropriate kwargs for building it.</span>
<span class="sd">        :param logger:      A logger object for logging debug info. [default: None]</span>

<span class="sd">        :returns: a PSF instance of the appropriate type.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">piff</span>
        <span class="kn">import</span> <span class="nn">yaml</span>

        <span class="n">logger</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Parsing PSF based on config dict:&quot;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="n">yaml</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">config_psf</span><span class="p">,</span> <span class="n">default_flow_style</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>

        <span class="c1"># Get the class to use for the PSF</span>
        <span class="n">psf_type</span> <span class="o">=</span> <span class="n">config_psf</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span> <span class="s1">&#39;Simple&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="s1">&#39;PSF&#39;</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;PSF type is </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">psf_type</span><span class="p">)</span>
        <span class="bp">cls</span> <span class="o">=</span> <span class="nb">getattr</span><span class="p">(</span><span class="n">piff</span><span class="p">,</span> <span class="n">psf_type</span><span class="p">)</span>

        <span class="c1"># Read any other kwargs in the psf field</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">parseKwargs</span><span class="p">(</span><span class="n">config_psf</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Build PSF object</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Building </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">psf_type</span><span class="p">)</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="bp">cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Done building PSF&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psf</span></div>

<div class="viewcode-block" id="PSF.parseKwargs"><a class="viewcode-back" href="../../psf.html#piff.PSF.parseKwargs">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">parseKwargs</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">config_psf</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Parse the psf field of a configuration dict and return the kwargs to use for</span>
<span class="sd">        initializing an instance of the class.</span>

<span class="sd">        The base class implementation just returns the kwargs as they are, but derived classes</span>
<span class="sd">        might want to override this if they need to do something more sophisticated with them.</span>

<span class="sd">        :param config_psf:      The psf field of the configuration dict, config[&#39;psf&#39;]</span>
<span class="sd">        :param logger:          A logger object for logging debug info. [default: None]</span>

<span class="sd">        :returns: a kwargs dict to pass to the initializer</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">config_psf</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kwargs</span></div>

<div class="viewcode-block" id="PSF.draw"><a class="viewcode-back" href="../../psf.html#piff.PSF.draw">[docs]</a>    <span class="k">def</span> <span class="nf">draw</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">chipnum</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="mf">1.0</span><span class="p">,</span> <span class="n">offset</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">stamp_size</span><span class="o">=</span><span class="mi">48</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
             <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sa">r</span><span class="sd">&quot;&quot;&quot;Draws an image of the PSF at a given location.</span>

<span class="sd">        The normal usage would be to specify (chipnum, x, y), in which case Piff will use the</span>
<span class="sd">        stored wcs information for that chip to interpolate to the given position and draw</span>
<span class="sd">        an image of the PSF:</span>

<span class="sd">            &gt;&gt;&gt; image = psf.draw(chipnum=4, x=103.3, y=592.0, stamp_size=48)</span>

<span class="sd">        However, if the PSF interpolation used extra properties for the interpolation</span>
<span class="sd">        (cf. psf.extra_interp_properties), you need to provide them as additional kwargs.</span>

<span class="sd">            &gt;&gt;&gt; print(psf.extra_interp_properties)</span>
<span class="sd">            (&#39;ri_color&#39;,)</span>
<span class="sd">            &gt;&gt;&gt; image = psf.draw(chipnum=4, x=103.3, y=592.0, ri_color=0.23, stamp_size=48)</span>

<span class="sd">        Normally, the image is constructed automatically based on stamp_size, in which case</span>
<span class="sd">        the WCS will be taken to be the local Jacobian at this location on the original image.</span>
<span class="sd">        However, if you provide your own image using the :image: argument, then whatever WCS</span>
<span class="sd">        is present in that image will be respected.  E.g. if you want an image of the PSF in</span>
<span class="sd">        sky coordinates rather than image coordinates, you can provide an image with just a</span>
<span class="sd">        pixel scale for the WCS.</span>

<span class="sd">        :param x:           The image x position.</span>
<span class="sd">        :param y:           The image y position.</span>
<span class="sd">        :param chipnum:     Which chip to use for WCS information. [default: 0, which is</span>
<span class="sd">                            appropriate if only using a single chip]</span>
<span class="sd">        :param flux:        Flux of PSF to be drawn [default: 1.0]</span>
<span class="sd">        :param offset:      (dx,dy) tuple giving offset of stellar center relative</span>
<span class="sd">                            to star.data.image_pos [default: (0,0)]</span>
<span class="sd">        :param stamp_size:  The size of the image to construct if no image is provided.</span>
<span class="sd">                            [default: 48]</span>
<span class="sd">        :param image:       An existing image on which to draw, if desired. [default: None]</span>
<span class="sd">        :param logger:      A logger object for logging debug info. [default: None]</span>
<span class="sd">        :param \**kwargs:   Any additional properties required for the interpolation.</span>

<span class="sd">        :returns:           A GalSim Image of the PSF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">properties</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;chipnum&#39;</span> <span class="p">:</span> <span class="n">chipnum</span><span class="p">}</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_interp_properties</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">key</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
                <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;Extra interpolation property </span><span class="si">%r</span><span class="s2"> is required&quot;</span><span class="o">%</span><span class="n">key</span><span class="p">)</span>
            <span class="n">properties</span> <span class="o">=</span> <span class="n">kwags</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">key</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s2">&quot;draw got an unexpecte keyword argument </span><span class="si">%r</span><span class="s2">&quot;</span><span class="o">%</span><span class="n">kwargs</span><span class="o">.</span><span class="n">keys</span><span class="p">()[</span><span class="mi">0</span><span class="p">])</span>

        <span class="n">image_pos</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">PositionD</span><span class="p">(</span><span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">)</span>
        <span class="n">world_pos</span> <span class="o">=</span> <span class="n">StarData</span><span class="o">.</span><span class="n">calculateFieldPos</span><span class="p">(</span><span class="n">image_pos</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">[</span><span class="n">chipnum</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="p">,</span>
                                               <span class="n">properties</span><span class="p">)</span>
        <span class="n">u</span><span class="p">,</span><span class="n">v</span> <span class="o">=</span> <span class="n">world_pos</span><span class="o">.</span><span class="n">x</span><span class="p">,</span> <span class="n">world_pos</span><span class="o">.</span><span class="n">y</span>

        <span class="c1"># We always use the correct wcs above for world_pos, but in makeTarget, we allow the</span>
        <span class="c1"># user&#39;s image.wcs to override.</span>
        <span class="k">if</span> <span class="n">image</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="n">image</span><span class="o">.</span><span class="n">wcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="p">[</span><span class="n">chipnum</span><span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wcs</span> <span class="o">=</span> <span class="n">image</span><span class="o">.</span><span class="n">wcs</span>

        <span class="n">star</span> <span class="o">=</span> <span class="n">Star</span><span class="o">.</span><span class="n">makeTarget</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="o">=</span><span class="n">y</span><span class="p">,</span> <span class="n">u</span><span class="o">=</span><span class="n">u</span><span class="p">,</span> <span class="n">v</span><span class="o">=</span><span class="n">v</span><span class="p">,</span> <span class="n">wcs</span><span class="o">=</span><span class="n">wcs</span><span class="p">,</span> <span class="n">properties</span><span class="o">=</span><span class="n">properties</span><span class="p">,</span>
                               <span class="n">stamp_size</span><span class="o">=</span><span class="n">stamp_size</span><span class="p">,</span> <span class="n">image</span><span class="o">=</span><span class="n">image</span><span class="p">,</span> <span class="n">pointing</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Drawing star at (</span><span class="si">%s</span><span class="s2">,</span><span class="si">%s</span><span class="s2">) on chip </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">chipnum</span><span class="p">)</span>

        <span class="c1"># Adjust the flux, center</span>
        <span class="n">center</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">offset_to_center</span><span class="p">(</span><span class="n">offset</span><span class="p">)</span>
        <span class="n">star</span> <span class="o">=</span> <span class="n">star</span><span class="o">.</span><span class="n">withFlux</span><span class="p">(</span><span class="n">flux</span><span class="p">,</span> <span class="n">center</span><span class="p">)</span>

        <span class="c1"># if a user specifies an image, then we want to preserve that image, so</span>
        <span class="c1"># copy_image = False. If a user doesn&#39;t specify an image, then it</span>
        <span class="c1"># doesn&#39;t matter if we overwrite it, so use copy_image=False</span>
        <span class="n">copy_image</span> <span class="o">=</span> <span class="kc">False</span>
        <span class="c1"># Draw the star and return the image</span>
        <span class="n">star</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">drawStar</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">copy_image</span><span class="o">=</span><span class="n">copy_image</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">star</span><span class="o">.</span><span class="n">data</span><span class="o">.</span><span class="n">image</span></div>

<div class="viewcode-block" id="PSF.drawStarList"><a class="viewcode-back" href="../../psf.html#piff.PSF.drawStarList">[docs]</a>    <span class="k">def</span> <span class="nf">drawStarList</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">stars</span><span class="p">,</span> <span class="n">copy_image</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Generate PSF images for given stars.</span>

<span class="sd">        :param stars:       List of Star instances holding information needed</span>
<span class="sd">                            for interpolation as well as an image/WCS into</span>
<span class="sd">                            which PSF will be rendered.</span>
<span class="sd">        :param copy_image:          If False, will use the same image object.</span>
<span class="sd">                                    If True, will copy the image and then overwrite it.</span>
<span class="sd">                                    [default: True]</span>

<span class="sd">        :returns:           List of Star instances with its image filled with</span>
<span class="sd">                            rendered PSF</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">return</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">drawStar</span><span class="p">(</span><span class="n">star</span><span class="p">,</span> <span class="n">copy_image</span><span class="o">=</span><span class="n">copy_image</span><span class="p">)</span> <span class="k">for</span> <span class="n">star</span> <span class="ow">in</span> <span class="n">stars</span><span class="p">]</span></div>

<div class="viewcode-block" id="PSF.write"><a class="viewcode-back" href="../../psf.html#piff.PSF.write">[docs]</a>    <span class="k">def</span> <span class="nf">write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write a PSF object to a file.</span>

<span class="sd">        :param file_name:   The name of the file to write to.</span>
<span class="sd">        :param logger:      A logger object for logging debug info. [default: None]</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Writing PSF to file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s1">&#39;rw&#39;</span><span class="p">,</span><span class="n">clobber</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_write</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;psf&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_write</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is the function that actually does the work for the write function.</span>
<span class="sd">        Composite PSF classes that need to iterate can call this multiple times as needed.</span>

<span class="sd">        :param fits:        An open fitsio.FITS object</span>
<span class="sd">        :param extname:     The name of the extension with the psf information.</span>
<span class="sd">        :param logger:      A logger object for logging debug info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">psf_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="o">.</span><span class="vm">__name__</span>
        <span class="n">write_kwargs</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="nb">dict</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">,</span> <span class="nb">type</span><span class="o">=</span><span class="n">psf_type</span><span class="p">))</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote the basic PSF information to extname </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extname</span><span class="p">)</span>
        <span class="n">Star</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">stars</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_stars&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote the PSF stars to extname </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_stars&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">writeWCS</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_wcs&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Wrote the PSF WCS to extname </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_wcs&#39;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_finish_write</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>

<div class="viewcode-block" id="PSF.read"><a class="viewcode-back" href="../../psf.html#piff.PSF.read">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">file_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read a PSF object from a file.</span>

<span class="sd">        :param file_name:   The name of the file to read.</span>
<span class="sd">        :param logger:      A logger object for logging debug info. [default: None]</span>

<span class="sd">        :returns: a PSF instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Reading PSF from file </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">file_name</span><span class="p">)</span>

        <span class="k">with</span> <span class="n">fitsio</span><span class="o">.</span><span class="n">FITS</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span><span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;opened FITS file&#39;</span><span class="p">)</span>
            <span class="k">return</span> <span class="bp">cls</span><span class="o">.</span><span class="n">_read</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="s1">&#39;psf&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span></div>

    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">_read</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;This is the function that actually does the work for the read function.</span>
<span class="sd">        Composite PSF classes that need to iterate can call this multiple times as needed.</span>

<span class="sd">        :param fits:        An open fitsio.FITS object</span>
<span class="sd">        :param extname:     The name of the extension with the psf information.</span>
<span class="sd">        :param logger:      A logger object for logging debug info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">piff</span>

        <span class="c1"># First get the PSF class from the &#39;psf&#39; extension</span>
        <span class="k">assert</span> <span class="n">extname</span> <span class="ow">in</span> <span class="n">fits</span>
        <span class="k">assert</span> <span class="s1">&#39;type&#39;</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
        <span class="n">psf_type</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()[</span><span class="s1">&#39;type&#39;</span><span class="p">]</span>
        <span class="k">assert</span> <span class="nb">len</span><span class="p">(</span><span class="n">psf_type</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">psf_type</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">psf_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">())</span>
        <span class="k">except</span> <span class="ne">AttributeError</span><span class="p">:</span>
            <span class="c1"># fitsio 1.0 returns strings</span>
            <span class="n">psf_type</span> <span class="o">=</span> <span class="n">psf_type</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Check that this is a valid PSF type</span>
        <span class="n">psf_classes</span> <span class="o">=</span> <span class="n">piff</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="n">get_all_subclasses</span><span class="p">(</span><span class="n">piff</span><span class="o">.</span><span class="n">PSF</span><span class="p">)</span>
        <span class="n">valid_psf_types</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">([</span> <span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">psf_classes</span> <span class="p">])</span>
        <span class="k">if</span> <span class="n">psf_type</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">valid_psf_types</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;psf type </span><span class="si">%s</span><span class="s2"> is not a valid Piff PSF&quot;</span><span class="o">%</span><span class="n">psf_type</span><span class="p">)</span>
        <span class="n">psf_cls</span> <span class="o">=</span> <span class="n">valid_psf_types</span><span class="p">[</span><span class="n">psf_type</span><span class="p">]</span>

        <span class="c1"># Read the stars, wcs, pointing values</span>
        <span class="n">stars</span> <span class="o">=</span> <span class="n">Star</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_stars&#39;</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;stars = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">stars</span><span class="p">)</span>
        <span class="n">wcs</span><span class="p">,</span> <span class="n">pointing</span> <span class="o">=</span> <span class="bp">cls</span><span class="o">.</span><span class="n">readWCS</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span> <span class="o">+</span> <span class="s1">&#39;_wcs&#39;</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;wcs = </span><span class="si">%s</span><span class="s2">, pointing = </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span><span class="n">wcs</span><span class="p">,</span><span class="n">pointing</span><span class="p">)</span>

        <span class="c1"># Get any other kwargs we need for this PSF type</span>
        <span class="n">kwargs</span> <span class="o">=</span> <span class="n">read_kwargs</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">)</span>
        <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;type&#39;</span><span class="p">,</span><span class="kc">None</span><span class="p">)</span>

        <span class="c1"># Make the PSF instance</span>
        <span class="n">psf</span> <span class="o">=</span> <span class="n">psf_cls</span><span class="p">(</span><span class="o">**</span><span class="n">kwargs</span><span class="p">)</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">stars</span> <span class="o">=</span> <span class="n">stars</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">wcs</span> <span class="o">=</span> <span class="n">wcs</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">pointing</span> <span class="o">=</span> <span class="n">pointing</span>

        <span class="c1"># Just in case the class needs to do something else at the end.</span>
        <span class="n">psf</span><span class="o">.</span><span class="n">_finish_read</span><span class="p">(</span><span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">psf</span>

    <span class="k">def</span> <span class="nf">_finish_read</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Finish up the read process</span>

<span class="sd">        In the base class, this is a no op, but for classes that need to do something else at</span>
<span class="sd">        the end of the read process, this hook is available to be overridden.</span>

<span class="sd">        (E.g. composite psf classes might copy the stars, wcs, pointing information into the</span>
<span class="sd">        various components.)</span>

<span class="sd">        :param fits:        An open fitsio.FITS object</span>
<span class="sd">        :param extname:     The name of the extension with the psf information.</span>
<span class="sd">        :param logger:      A logger object for logging debug info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">pass</span>


<div class="viewcode-block" id="PSF.writeWCS"><a class="viewcode-back" href="../../psf.html#piff.PSF.writeWCS">[docs]</a>    <span class="k">def</span> <span class="nf">writeWCS</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Write the WCS information to a FITS file.</span>

<span class="sd">        :param fits:        An open fitsio.FITS object</span>
<span class="sd">        :param extname:     The name of the extension to write to</span>
<span class="sd">        :param logger:      A logger object for logging debug info.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">base64</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pickle</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">config</span><span class="o">.</span><span class="n">LoggerWrapper</span><span class="p">(</span><span class="n">logger</span><span class="p">)</span>

        <span class="c1"># Start with the chipnums, which may be int or str type.</span>
        <span class="c1"># Assume they are all the same type at least.</span>
        <span class="n">chipnums</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
        <span class="n">cols</span> <span class="o">=</span> <span class="p">[</span> <span class="n">chipnums</span> <span class="p">]</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">dtype</span><span class="p">(</span><span class="nb">type</span><span class="p">(</span><span class="n">chipnums</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">kind</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">typecodes</span><span class="p">[</span><span class="s1">&#39;AllInteger&#39;</span><span class="p">]:</span>
            <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;chipnums&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="c1"># coerce to string, just in case it&#39;s something else.</span>
            <span class="n">chipnums</span> <span class="o">=</span> <span class="p">[</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chipnums</span> <span class="p">]</span>
            <span class="n">max_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">c</span><span class="p">)</span> <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">chipnums</span> <span class="p">])</span>
            <span class="n">dtypes</span> <span class="o">=</span> <span class="p">[</span> <span class="p">(</span><span class="s1">&#39;chipnums&#39;</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">max_len</span><span class="p">)</span> <span class="p">]</span>

        <span class="c1"># GalSim WCS objects can be serialized via pickle</span>
        <span class="n">wcs_str</span> <span class="o">=</span> <span class="p">[</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64encode</span><span class="p">(</span><span class="n">pickle</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">w</span><span class="p">))</span> <span class="k">for</span> <span class="n">w</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">wcs</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="p">]</span>
        <span class="n">max_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">([</span> <span class="nb">len</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">])</span>
        <span class="c1"># Some GalSim WCS serializations are rather long.  In particular, the Pixmappy one</span>
        <span class="c1"># is longer than the maximum length allowed for a column in a fits table (28799).</span>
        <span class="c1"># So split it into chunks of size 2**14 (mildly less than this maximum).</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="mi">2</span><span class="o">**</span><span class="mi">14</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="n">max_len</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">[</span><span class="n">nchunks</span><span class="p">]</span><span class="o">*</span><span class="nb">len</span><span class="p">(</span><span class="n">chipnums</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">dtypes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span> <span class="p">(</span><span class="s1">&#39;nchunks&#39;</span><span class="p">,</span> <span class="nb">int</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">if</span> <span class="n">nchunks</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s1">&#39;Using </span><span class="si">%d</span><span class="s1"> chunks for the wcs pickle string&#39;</span><span class="p">,</span><span class="n">nchunks</span><span class="p">)</span>

        <span class="c1"># Update to size of chunk we actually need.</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_len</span> <span class="o">+</span> <span class="n">nchunks</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="o">//</span> <span class="n">nchunks</span>

        <span class="n">chunks</span> <span class="o">=</span> <span class="p">[</span> <span class="p">[</span> <span class="n">s</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="n">chunk_size</span><span class="p">]</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">max_len</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span> <span class="p">]</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span>
        <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">chunks</span><span class="p">))</span>
        <span class="n">dtypes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">(</span><span class="s1">&#39;wcs_str_</span><span class="si">%04d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span><span class="p">,</span> <span class="nb">bytes</span><span class="p">,</span> <span class="n">chunk_size</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">)</span> <span class="p">)</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">pointing</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Currently, there is only one pointing for all the chips, but write it out</span>
            <span class="c1"># for each row anyway.</span>
            <span class="n">dtypes</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">((</span><span class="s1">&#39;ra&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">),</span> <span class="p">(</span><span class="s1">&#39;dec&#39;</span><span class="p">,</span> <span class="nb">float</span><span class="p">))</span> <span class="p">)</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="o">.</span><span class="n">ra</span> <span class="o">/</span> <span class="n">galsim</span><span class="o">.</span><span class="n">hours</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chipnums</span><span class="p">)</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">pointing</span><span class="o">.</span><span class="n">dec</span> <span class="o">/</span> <span class="n">galsim</span><span class="o">.</span><span class="n">degrees</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">chipnums</span><span class="p">)</span>
            <span class="n">cols</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span> <span class="p">(</span><span class="n">ra</span><span class="p">,</span> <span class="n">dec</span><span class="p">)</span> <span class="p">)</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">cols</span><span class="p">)),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">dtypes</span><span class="p">)</span>
        <span class="n">fits</span><span class="o">.</span><span class="n">write_table</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">extname</span><span class="o">=</span><span class="n">extname</span><span class="p">)</span></div>

<div class="viewcode-block" id="PSF.readWCS"><a class="viewcode-back" href="../../psf.html#piff.PSF.readWCS">[docs]</a>    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">readWCS</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">fits</span><span class="p">,</span> <span class="n">extname</span><span class="p">,</span> <span class="n">logger</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read the WCS information from a FITS file.</span>

<span class="sd">        :param fits:        An open fitsio.FITS object</span>
<span class="sd">        :param extname:     The name of the extension to read from</span>
<span class="sd">        :param logger:      A logger object for logging debug info.</span>

<span class="sd">        :returns: wcs, pointing where wcs is a dict of galsim.BaseWCS instances and</span>
<span class="sd">                                      pointing is a galsim.CelestialCoord instance</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">import</span> <span class="nn">base64</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">cPickle</span> <span class="k">as</span> <span class="nn">pickle</span>
        <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
            <span class="kn">import</span> <span class="nn">pickle</span>

        <span class="k">assert</span> <span class="n">extname</span> <span class="ow">in</span> <span class="n">fits</span>
        <span class="k">assert</span> <span class="s1">&#39;chipnums&#39;</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>
        <span class="k">assert</span> <span class="s1">&#39;nchunks&#39;</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">()</span>

        <span class="n">data</span> <span class="o">=</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

        <span class="n">chipnums</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;chipnums&#39;</span><span class="p">]</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;nchunks&#39;</span><span class="p">]</span>
        <span class="n">nchunks</span> <span class="o">=</span> <span class="n">nchunks</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># These are all equal, so just take first one.</span>

        <span class="n">wcs_keys</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;wcs_str_</span><span class="si">%04d</span><span class="s1">&#39;</span><span class="o">%</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nchunks</span><span class="p">)</span> <span class="p">]</span>
        <span class="n">wcs_str</span> <span class="o">=</span> <span class="p">[</span> <span class="n">data</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wcs_keys</span> <span class="p">]</span> <span class="c1"># Get all wcs_str columns</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wcs_str</span> <span class="o">=</span> <span class="p">[</span> <span class="sa">b</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">wcs_str</span><span class="p">)</span> <span class="p">]</span>  <span class="c1"># Rejoint into single string each</span>
        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
            <span class="c1"># fitsio 1.0 returns strings</span>
            <span class="n">wcs_str</span> <span class="o">=</span> <span class="p">[</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">wcs_str</span><span class="p">)</span> <span class="p">]</span>  <span class="c1"># Rejoint into single string each</span>

        <span class="n">wcs_str</span> <span class="o">=</span> <span class="p">[</span> <span class="n">base64</span><span class="o">.</span><span class="n">b64decode</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span> <span class="c1"># Convert back from b64 encoding</span>
        <span class="c1"># Convert back into wcs objects</span>
        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">wcs_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;bytes&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If the file was written by py2, the bytes encoding might raise here,</span>
                <span class="c1"># or it might not until we try to use it.</span>
                <span class="n">wcs_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">wcs_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span>

        <span class="n">wcs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">chipnums</span><span class="p">,</span> <span class="n">wcs_list</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">sys</span><span class="o">.</span><span class="n">version_info</span> <span class="o">&gt;</span> <span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">0</span><span class="p">):</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># If this doesn&#39;t work, then the file was probably written by py2, not py3</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Failed to decode wcs with bytes encoding.&#39;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s1">&#39;Retry with encoding=&quot;latin1&quot; in case file written with python 2.&#39;</span><span class="p">)</span>
                <span class="n">wcs_list</span> <span class="o">=</span> <span class="p">[</span> <span class="n">pickle</span><span class="o">.</span><span class="n">loads</span><span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s1">&#39;latin1&#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">s</span> <span class="ow">in</span> <span class="n">wcs_str</span> <span class="p">]</span>
                <span class="n">wcs</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="n">chipnums</span><span class="p">,</span> <span class="n">wcs_list</span><span class="p">))</span>
                <span class="nb">repr</span><span class="p">(</span><span class="n">wcs</span><span class="p">)</span>

        <span class="c1"># Work-around for a change in the GalSim API with 2.0</span>
        <span class="c1"># If the piff file was written with pre-2.0 GalSim, this fixes it.</span>
        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">wcs</span><span class="p">:</span>
            <span class="n">w</span> <span class="o">=</span> <span class="n">wcs</span><span class="p">[</span><span class="n">key</span><span class="p">]</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="s1">&#39;_origin&#39;</span><span class="p">)</span> <span class="ow">and</span>  <span class="nb">isinstance</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">_origin</span><span class="p">,</span> <span class="n">galsim</span><span class="o">.</span><span class="n">_galsim</span><span class="o">.</span><span class="n">PositionD</span><span class="p">):</span>
                <span class="n">w</span><span class="o">.</span><span class="n">_origin</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">PositionD</span><span class="p">(</span><span class="n">w</span><span class="o">.</span><span class="n">_origin</span><span class="p">)</span>

        <span class="k">if</span> <span class="s1">&#39;ra&#39;</span> <span class="ow">in</span> <span class="n">fits</span><span class="p">[</span><span class="n">extname</span><span class="p">]</span><span class="o">.</span><span class="n">get_colnames</span><span class="p">():</span>
            <span class="n">ra</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;ra&#39;</span><span class="p">]</span>
            <span class="n">dec</span> <span class="o">=</span> <span class="n">data</span><span class="p">[</span><span class="s1">&#39;dec&#39;</span><span class="p">]</span>
            <span class="n">pointing</span> <span class="o">=</span> <span class="n">galsim</span><span class="o">.</span><span class="n">CelestialCoord</span><span class="p">(</span><span class="n">ra</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">galsim</span><span class="o">.</span><span class="n">hours</span><span class="p">,</span> <span class="n">dec</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">galsim</span><span class="o">.</span><span class="n">degrees</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pointing</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">wcs</span><span class="p">,</span> <span class="n">pointing</span></div></div>

<span class="c1"># Make a global function, piff.read, as an alias for piff.PSF.read, since that&#39;s the main thing</span>
<span class="c1"># users will want to do as their starting point for using a piff file.</span>
<span class="k">def</span> <span class="nf">read</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Read a Piff PSF object from a file.</span>

<span class="sd">    :param file_name:   The name of the file to read.</span>
<span class="sd">    :param logger:      A logger object for logging debug info. [default: None]</span>

<span class="sd">    :returns: a piff.PSF instance</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">PSF</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">file_name</span><span class="p">,</span> <span class="n">logger</span><span class="o">=</span><span class="n">logger</span><span class="p">)</span>
</pre></div>

          </div>
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<div id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" />
      <input type="submit" value="Go" />
    </form>
    </div>
</div>
<script>$('#searchbox').show(0);</script>
        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="related" role="navigation" aria-label="related navigation">
      <h3>Navigation</h3>
      <ul>
        <li class="right" style="margin-right: 10px">
          <a href="../../genindex.html" title="General Index"
             >index</a></li>
        <li class="nav-item nav-item-0"><a href="../../index.html">Piff 0.4 documentation</a> &#187;</li>
          <li class="nav-item nav-item-1"><a href="../index.html" >Module code</a> &#187;</li> 
      </ul>
    </div>
    <div class="footer" role="contentinfo">
        &#169; Copyright 2019.
      Created using <a href="http://sphinx-doc.org/">Sphinx</a> 3.0.3.
    </div>
  </body>
</html>